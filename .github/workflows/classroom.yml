name: GitHub Classroom Workflow

on: 
  workflow_dispatch: # รันด้วยมือเท่านั้น

jobs:
  build:
    name: Autograding
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install Dependencies
        run: npm install
      
      # สร้างไฟล์ Test จาก Secret
      - name: Create Secret Test
        run: |
          mkdir -p evaluation
          echo "Y29uc3QgZGFzaGJvYXJkID0gcmVxdWlyZSgnLi4vc3JjL2Rhc2hib2FyZCcpOwoKLy8g4LmA4Lie4Li04LmI4LihIFRpbWVvdXQg4LmA4Lie4Lij4Liy4LiwIEFQSSDguIrguYnguLIKamVzdC5zZXRUaW1lb3V0KDE1MDAwKTsKCmRlc2NyaWJlKCdUZWFjaGVyIEV2YWx1YXRpb24gKEhpZGRlbiknLCAoKSA9PiB7CgogICAgdGVzdCgnUGVyZm9ybWFuY2UgJiBTdGFiaWxpdHkgQ2hlY2snLCBhc3luYyAoKSA9PiB7CiAgICAgICAgLy8g4LmA4Lij4Liy4LiI4Liw4Lij4Lix4LiZIGxvb3AgNSDguKPguK3guJog4LmA4Lie4Li34LmI4Lit4LiX4LmJ4Liy4LiX4Liy4Lii4LmC4Lit4LiB4Liy4LiqIDMwJSBmYWlsCiAgICAgICAgY29uc3QgaXRlcmF0aW9ucyA9IDU7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFtdOwoKICAgICAgICBjb25zb2xlLmxvZygnVGVhY2hlcjogUnVubmluZyBzdHJlc3MgdGVzdC4uLicpOwogICAgICAgIGNvbnN0IHN0YXJ0VG90YWwgPSBEYXRlLm5vdygpOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZXJhdGlvbnM7IGkrKykgewogICAgICAgICAgICAvLyDguKvguKfguLHguIfguKfguYjguLLguJzguLnguYnguKrguKHguLHguITguKPguIjguLDguYTguKHguYggdGhyb3cgZXJyb3Ig4Lit4Lit4LiB4Lih4LiyIOC5geC4leC5iCByZXR1cm4gZGF0YSDguIHguKXguLHguJrguKHguLLguYTguJTguYkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGRhc2hib2FyZC5sb2FkRGFzaGJvYXJkKCk7CiAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocmVzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRvdGFsOwoKICAgICAgICAvLyAxLiBDSEVDSyBTVUNDRVNTIFJBVEUgKFJldHJ5IExvZ2ljKQogICAgICAgIC8vIEFQSSDguJ7guLHguIcgMzAlIOC4o+C4seC4mSA1IOC4o+C4reC4miAo4Lij4Lin4LihIDE1IGNhbGxzKSDguJXguYnguK3guIfguKHguLUgZXJyb3Ig4LmB4LiZ4LmI4LmGCiAgICAgICAgLy8g4LiW4LmJ4Liy4LmE4Lih4LmI4Lih4Li1IFJldHJ5IOC5gOC4peC4oiDguIjguLDguKHguLUgZmFpbHVyZXMg4Lib4LiZ4Lih4LiyCiAgICAgICAgY29uc3Qgc3VjY2Vzc0NvdW50ID0gcmVzdWx0cy5maWx0ZXIociA9PiByLnN1Y2Nlc3MgPT09IHRydWUpLmxlbmd0aDsKICAgICAgICBjb25zb2xlLmxvZyhgU3VjY2VzcyBSYXRlOiAke3N1Y2Nlc3NDb3VudH0vJHtpdGVyYXRpb25zfWApOwoKICAgICAgICAvLyDguKLguK3guKHguYPguKvguYnguJ7guKXguLLguJTguYTguJTguYkgMSDguITguKPguLHguYnguIcgKOC4geC4o+C4k+C4teC4lOC4p+C4h+C5geC4leC4gSBSZXRyeSDguITguKPguJogMyDguYHguKXguYnguKfguKLguLHguIfguJ7guLHguIcpCiAgICAgICAgZXhwZWN0KHN1Y2Nlc3NDb3VudCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg0KTsKCiAgICAgICAgLy8gMi4gQ0hFQ0sgU1BFRUQgKFBhcmFsbGVsaXNtKQogICAgICAgIC8vIOC4luC5ieC4siBTZXF1ZW50aWFsOiAoQXZnIDFzICogMyBBUElzKSAqIDUgcm91bmRzID0gfjE1IOC4p+C4tOC4meC4suC4l+C4tQogICAgICAgIC8vIOC4luC5ieC4siBQYXJhbGxlbDogKEF2ZyAxcykgKiA1IHJvdW5kcyA9IH41LTcg4Lin4Li04LiZ4Liy4LiX4Li1CiAgICAgICAgY29uc29sZS5sb2coYFRvdGFsIER1cmF0aW9uIGZvciA1IHJvdW5kczogJHtkdXJhdGlvbn1tc2ApOwoKICAgICAgICAvLyDguJbguYnguLLguYDguIHguLTguJkgMTIg4Lin4Li04LiZ4Liy4LiX4Li1IOC5geC4quC4lOC4h+C4p+C5iOC4suC4ouC4seC4h+C5gOC4m+C5h+C4mSBTZXF1ZW50aWFsIOC4q+C4o+C4t+C4rSBSZXRyeSDguYHguJrguJrguYTguKHguYjguKHguLXguJvguKPguLDguKrguLTguJfguJjguLTguKDguLLguJ4KICAgICAgICBleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbigxMjAwMCk7CiAgICB9KTsKfSk7" | base64 -d > evaluation/teacher.test.js
        shell: bash

      # รัน Test
      - name: Teacher Grading
        run: npm run test:grade
